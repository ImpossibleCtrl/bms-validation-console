<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BMS Validation Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#0f1115; --bg2:#1e2330; --bg3:#171a21; --fg:#e9edf1; --muted:#b8bec7;
            --green:#22c55e; --blue:#3b82f6; --orange:#f59e0b; --red:#ef4444; --shadow:0 6px 18px rgba(0,0,0,0.25); }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{background:var(--bg3);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px;letter-spacing:.3px}
    nav{display:flex;gap:10px}
    .tabbtn{background:var(--bg2);color:var(--fg);border:none;padding:10px 14px;border-radius:9px;cursor:pointer}
    .tabbtn.active{background:var(--blue)}
    .wrap{padding:16px}
    .tabs{display:none}.tabs.active{display:block}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    .row{display:flex;gap:16px}
    .card{background:var(--bg2);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .subtle{color:var(--muted);font-size:12px}
    label{display:block;margin:6px 0 4px;font-size:13px;color:#cdd3dc}
    select,input[type=file],button,textarea{width:100%;margin-bottom:10px}
    select,input[type=file],textarea{background:#0e1220;color:var(--fg);border:1px solid #2a3040;border-radius:8px;padding:8px}
    button{background:#2b3345;color:#fff;border:none;border-radius:10px;padding:9px 12px;cursor:pointer}
    button.primary{background:var(--green);color:#08130c}
    button.accent{background:var(--blue)}
    button.warn{background:var(--orange)}
    button.danger{background:var(--red)}
    table{border-collapse:collapse;width:100%;font-size:13px}
    th,td{border-bottom:1px solid #2a3040;padding:6px 8px;vertical-align:top}
    th{position:sticky;top:0;background:var(--bg3);text-align:left}
    .pill{display:inline-block;border-radius:6px;padding:2px 6px;font-size:12px}
    .pill.error{background:#ff5d5d33;color:#ff9a9a}
    .pill.warn{background:#ffb84d33;color:#ffd79a}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .hide{display:none}
  </style>
</head>
<body>
<header>
  <h1>BMS Validation Dashboard</h1>
  <nav>
    <button class="tabbtn active" onclick="showTab('validate', this)">Validation</button>
    <button class="tabbtn" onclick="showTab('pivot', this)">Pivot + Charts</button>
    <button class="tabbtn" onclick="showTab('correct', this)">Corrected Data</button>
  </nav>
</header>

<div class="wrap">
  <section id="validate" class="tabs active">
    <div class="grid">
      <div class="card">
        <h2>Upload</h2>
        <label>Data CSV</label><input type="file" id="dataCsv" accept=".csv" />
        <label>Data XLSX</label><input type="file" id="dataXlsx" accept=".xlsx" />
        <label>Reference CSV (optional) — Asset Number lookup</label><input type="file" id="refCsv" accept=".csv" />
        <div id="fileStatus" class="subtle">No file loaded (demo auto-loads)</div>
        <div class="toolbar">
          <button class="primary" onclick="runValidation()">Run Validation</button>
          <button class="accent" onclick="downloadFailures()">Download Failures CSV</button>
          <button class="warn" onclick="disableDemo()">Disable Demo Data (session)</button>
        </div>
      </div>
      <div class="card">
        <h2>Results</h2>
        <div id="resultsWrap">Loading demo data…</div>
      </div>
    </div>
  </section>

  <section id="pivot" class="tabs">
    <div class="two">
      <div class="card">
        <h2>Pivot Builder</h2>
        <label>Row field</label><select id="rowField"></select>
        <label>Column field (optional)</label><select id="colField"></select>
        <label>Value field</label><select id="valField"></select>
        <label>Aggregation</label>
        <select id="aggFunc"><option value="count">Count</option><option value="sum">Sum</option><option value="avg">Average</option></select>
        <div class="toolbar">
          <button class="primary" onclick="generatePivot()">Generate Pivot</button>
          <button class="accent" onclick="downloadPivotExcel()">Download Pivot Excel</button>
          <button onclick="addPivotToWorkbook()">Add to Workbook</button>
          <button onclick="downloadAllPivots()">Download All Pivots</button>
        </div>
        <h3>Saved Pivots</h3>
        <div class="toolbar">
          <select id="savedPivots" style="flex:1"></select>
          <button onclick="saveCurrentPivot()">Save Current</button>
          <button onclick="loadSavedPivot()">Load</button>
          <button class="warn" onclick="deleteSavedPivot()">Delete</button>
          <button class="danger" onclick="resetDefaultPivots()">Reset Defaults</button>
        </div>
      </div>
      <div class="card"><h2>Pivot Table</h2><div id="pivotTable">No pivot yet</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <h2>Chart</h2>
      <div class="toolbar">
        <button onclick="drawChart('bar')">Bar</button>
        <button onclick="drawChart('pie')">Pie</button>
        <button onclick="drawChart('line')">Line</button>
        <button class="accent" onclick="downloadChart()">Download Chart PNG</button>
      </div>
      <canvas id="chartCanvas" height="140"></canvas>
    </div>
  </section>

  <section id="correct" class="tabs">
    <div class="card">
      <h2>Corrected Dataset</h2>
      <p class="subtle">Fills missing required fields with <code>MISSING_&lt;field&gt;</code> and normalizes simple Online/Offline variants.</p>
      <button class="primary" onclick="downloadCorrectedExcel()">Download Corrected Excel</button>
    </div>
  </section>
</div>

<script>
let headers = []; let rows = []; let failures = []; let refSet = null;
let chart = null; let demoEnabled = true; let pivotMatrix = null; let pivotMeta = null; let workbookQueue = [];

function showTab(id, btn){ document.querySelectorAll('.tabs').forEach(el=>el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); }

// Loaders
dataCsv.onchange = e => { const f=e.target.files[0]; if(!f) return;
  Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{ headers=res.meta.fields; rows=res.data;
    fileStatus.innerText = `Loaded ${f.name} (${rows.length} rows)`; runValidation(); populatePivotFields(); }}); };
dataXlsx.onchange = async e => { const f=e.target.files[0]; if(!f) return;
  const data = new Uint8Array(await f.arrayBuffer()); const wb = XLSX.read(data,{type:'array'});
  const ws = wb.Sheets[wb.SheetNames[0]]; const arr = XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
  rows = arr; headers = Object.keys(arr[0]||{}); fileStatus.innerText = `Loaded ${f.name} (${rows.length} rows)`;
  runValidation(); populatePivotFields(); };
refCsv.onchange = e => { const f=e.target.files[0]; if(!f) return;
  Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{ const col=(res.meta.fields||[]).find(h=>h.toLowerCase()==='asset number'||h.toLowerCase()==='asset_number');
    if(!col){ alert('Reference CSV must contain "Asset Number" column'); return; }
    refSet = new Set(res.data.map(r=>String(r[col]).trim())); alert(`Loaded ${refSet.size} Asset Numbers`); }}); };

// Demo auto-load
window.addEventListener('load', async ()=>{ if(!demoEnabled) return;
  try{ const resp = await fetch('demo_data.csv'); if(!resp.ok) throw new Error('missing');
    const text = await resp.text(); const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
    headers = parsed.meta.fields; rows = parsed.data; fileStatus.innerText = `Demo loaded (${rows.length} rows)`;
    runValidation(); populatePivotFields(); selectIfExists('rowField','Status'); selectIfExists('colField',''); selectIfExists('valField','Asset Number');
    document.getElementById('aggFunc').value='count'; generatePivot(); drawChart('bar'); ensureDefaultSavedPivot(); }
  catch(e){ resultsWrap.innerText = 'Demo not found. Upload your file to begin.'; }});
function disableDemo(){ demoEnabled=false; headers=[]; rows=[]; failures=[]; pivotMatrix=null; pivotMeta=null; resultsWrap.innerText='Demo disabled. Upload your file.';
  fileStatus.innerText='Demo disabled'; pivotTable.innerText='No pivot yet'; if(chart){ chart.destroy(); chart=null; } }

// Validation
const REQUIRED = ["Site Name","Work Zone","Building Name","Floor","Room","Status","Asset Number","Asset Name"];
function runValidation(){ failures=[]; let i=2;
  for(const r of rows){
    for(const f of REQUIRED){ const v=(r[f]??'').toString().trim(); if(v==='') failures.push({row:i,severity:'error',message:`${f} required`}); }
    const sv=(r["Status"]||'').toString().trim();
    if(sv && !/^online$/i.test(sv) && !/^offline$/i.test(sv)){ failures.push({row:i,severity:'error',message:`Status must be Online or Offline (got "${sv}")`}); }
    const tag=(r["TagID"]||'').toString().trim(), reason=(r["Reason Not Tagged"]||'').toString().trim();
    if(tag==='' && reason===''){ failures.push({row:i,severity:'error',message:'Provide TagID or Reason Not Tagged'}); }
    if(refSet){ const an=(r["Asset Number"]||'').toString().trim(); if(an && !refSet.has(an)){ failures.push({row:i,severity:'warn',message:`Asset Number "${an}" not in reference`}); } }
    i++;
  } renderFailures(); }
function renderFailures(){ if(!failures.length){ resultsWrap.innerText='No failures'; return; }
  let html='<table><thead><tr><th>Row</th><th>Severity</th><th>Message</th></tr></thead><tbody>';
  for(const f of failures){ html+=`<tr><td>${f.row}</td><td><span class="pill ${f.severity}">${f.severity}</span></td><td>${f.message}</td></tr>`; }
  html+='</tbody></table>'; resultsWrap.innerHTML=html; }
function downloadFailures(){ if(!failures.length){ alert('No failures'); return; } const out=[['Row','Severity','Message'],...failures.map(f=>[f.row,f.severity,f.message])];
  const ws=XLSX.utils.aoa_to_sheet(out); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Failures'); XLSX.writeFile(wb,'failures.csv',{bookType:'csv'}); }

// Pivot
function populatePivotFields(){ const opts=headers.map(h=>`<option value="${h}">${h}</option>`).join('');
  rowField.innerHTML=opts; colField.innerHTML='<option value="">(none)</option>'+opts; valField.innerHTML=opts; }
function selectIfExists(id,val){ const sel=document.getElementById(id); Array.from(sel.options).forEach(o=>{ if(o.value===val) sel.value=val; }); }
function generatePivot(){
  if(!headers.length||!rows.length){ pivotTable.innerText='No data'; return; }
  const rF=rowField.value||headers[0], cF=colField.value||'', vF=valField.value||headers[0], agg=aggFunc.value||'count';
  const map=new Map(), rKeys=[], cKeys=new Set();
  const getNum=v=>{ const n=parseFloat(v); return isNaN(n)?0:n; };
  for(const r of rows){ const rk=(r[rF]??'(blank)').toString(); const ck=cF?(r[cF]??'(blank)').toString():''; const vv=(r[vF]??'').toString();
    if(!rKeys.includes(rk)) rKeys.push(rk); if(cF) cKeys.add(ck); const key=rk+'||'+ck; if(!map.has(key)) map.set(key,[]); map.get(key).push(vv); }
  const cArr=cF?Array.from(cKeys):[]; const header=[rF].concat(cF?cArr:['Value']); const matrix=[header];
  const aggFn = (arr)=> agg==='count'?arr.length : (agg==='sum'?arr.reduce((a,b)=>a+getNum(b),0):(arr.length?arr.reduce((a,b)=>a+getNum(b),0)/arr.length:0));
  for(const rk of rKeys){ const out=[rk]; if(cF){ for(const ck of cArr){ const arr=map.get(rk+'||'+ck)||[]; out.push(aggFn(arr)); } } else { const arr=map.get(rk+'||')||[]; out.push(aggFn(arr)); } matrix.push(out); }
  pivotMatrix=matrix; pivotMeta={rowField:rF,colField:cF,valField:vF,aggFunc:agg}; renderPivotTable(matrix); }
function renderPivotTable(m){ if(!m){ pivotTable.innerText='No pivot'; return; }
  let html='<table><thead><tr>'+m[0].map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>';
  for(let i=1;i<m.length;i++){ html+='<tr>'+m[i].map(v=>`<td>${v}</td>`).join('')+'</tr>'; } html+='</tbody></table>'; pivotTable.innerHTML=html; }

// Charts
function drawChart(type){ if(!pivotMatrix){ alert('No pivot'); return; }
  const labels=pivotMatrix.slice(1).map(r=>r[0]); const cols=pivotMatrix[0].slice(1);
  const ctx=document.getElementById('chartCanvas').getContext('2d'); if(chart) chart.destroy();
  let data; if(cols.length===1 || type==='pie'){ const vals=pivotMatrix.slice(1).map(r=>r[1]); data={labels,datasets:[{label:cols[0]||'Value',data:vals}]}; }
  else{ const ds=[]; for(let c=1;c<pivotMatrix[0].length;c++){ ds.push({label:pivotMatrix[0][c],data:pivotMatrix.slice(1).map(r=>r[c])}); } data={labels,datasets:ds}; }
  chart=new Chart(ctx,{type:(type==='pie'?'pie':(type==='line'?'line':'bar')),data,options:{responsive:true,plugins:{legend:{display:true}}}}); }
function downloadChart(){ if(!chart){ alert('No chart'); return; } const a=document.createElement('a'); a.href=chart.toBase64Image(); a.download='pivot_chart.png'; a.click(); }

// Pivot exports
function downloadPivotExcel(){ if(!pivotMatrix){ alert('No pivot'); return; } const ws=XLSX.utils.aoa_to_sheet(pivotMatrix); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,(pivotMeta?.rowField||'Pivot').substring(0,28)||'Pivot'); XLSX.writeFile(wb,'pivot.xlsx'); }
function addPivotToWorkbook(){ if(!pivotMatrix){ alert('No pivot'); return; } workbookQueue.push({matrix:JSON.parse(JSON.stringify(pivotMatrix)),name:(pivotMeta?.rowField||'Pivot')});
  alert(`Pivot added. Workbook has ${workbookQueue.length} sheet(s).`); }
function downloadAllPivots(){ if(!workbookQueue.length){ alert('No queued pivots'); return; } const wb=XLSX.utils.book_new();
  workbookQueue.forEach((p,i)=>{ const ws=XLSX.utils.aoa_to_sheet(p.matrix); const nm=(p.name||('Pivot'+(i+1))).substring(0,28)||('Pivot'+(i+1));
    XLSX.utils.book_append_sheet(wb,ws,nm); }); XLSX.writeFile(wb,'pivots.xlsx'); }

// Saved pivots
function ensureDefaultSavedPivot(){ const key='savedPivots'; let arr=JSON.parse(localStorage.getItem(key)||'[]');
  if(!arr.find(p=>p.name==='Assets by Status')){ arr.push({name:'Assets by Status',rowField:'Status',colField:'',valField:'Asset Number',aggFunc:'count'});
    localStorage.setItem(key,JSON.stringify(arr)); } refreshSavedPivots(); }
function refreshSavedPivots(){ const key='savedPivots'; let arr=JSON.parse(localStorage.getItem(key)||'[]');
  savedPivots.innerHTML = arr.map((p,i)=>`<option value="${i}">${p.name}</option>`).join(''); }
function saveCurrentPivot(){ const key='savedPivots'; let arr=JSON.parse(localStorage.getItem(key)||'[]'); const name=prompt('Name this pivot:','My Pivot'); if(!name) return;
  arr.push({name,rowField:rowField.value,colField:colField.value,valField:valField.value,aggFunc:aggFunc.value}); localStorage.setItem(key,JSON.stringify(arr)); refreshSavedPivots(); }
function loadSavedPivot(){ const key='savedPivots'; let arr=JSON.parse(localStorage.getItem(key)||'[]'); const idx=parseInt(savedPivots.value||'-1',10);
  if(isNaN(idx)||!arr[idx]){ alert('No saved pivot selected'); return; } const p=arr[idx]; selectIfExists('rowField',p.rowField); selectIfExists('colField',p.colField);
  selectIfExists('valField',p.valField); aggFunc.value=p.aggFunc||'count'; generatePivot(); drawChart('bar'); }
function deleteSavedPivot(){ const key='savedPivots'; let arr=JSON.parse(localStorage.getItem(key)||'[]'); const idx=parseInt(savedPivots.value||'-1',10);
  if(isNaN(idx)||!arr[idx]){ alert('No saved pivot selected'); return; } arr.splice(idx,1); localStorage.setItem(key,JSON.stringify(arr)); refreshSavedPivots(); }
function resetDefaultPivots(){ localStorage.setItem('savedPivots','[]'); ensureDefaultSavedPivot(); }

// Corrected export
function normalizeStatus(s){ const v=(s||'').toString().trim().toLowerCase(); if(v==='online'||v==='on')return'Online'; if(v==='offline'||v==='off')return'Offline'; return s; }
function downloadCorrectedExcel(){ if(!rows.length){ alert('No data'); return; } const out=rows.map(r=>{ const rr={...r};
  for(const f of REQUIRED){ if(!rr[f]||rr[f].toString().trim()==='') rr[f]=`MISSING_${f.replace(/\s+/g,'_').toUpperCase()}`; }
  rr['Status']=normalizeStatus(rr['Status']); return rr; });
  const ws=XLSX.utils.json_to_sheet(out,{header:headers.length?headers:Object.keys(out[0])}); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Corrected'); XLSX.writeFile(wb,'corrected.xlsx'); }
</script>
</body>
</html>
